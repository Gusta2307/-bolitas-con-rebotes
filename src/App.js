import React, { Component } from 'react';
import Ball from "./Ball"
import Ball_Throw from './Ball_throw';
import My_Audio from './Audio_';
import NavBar from './components/NavBar';
import {startRecording} from './components/GifWritten';
 

export default class App extends Component{
  
  constructor(times=null, throws_list=[[[6.325276882724722, 1, 2, 0, 0.024502436460453275, 0], [5.467519199250946, 1, 1, 0, 2.6486958857420895, 0], [5.467519199250946, 1, 1, 0, 3.8096936157420895, 0], [5.467519199250946, 1, 1, 0, 5.318990665742089, 0], [5.467519199250946, 1, 1, 0, 6.990827405742089, 0], [5.467519199250946, 1, 1, 0, 7.98928545574209, 0], [5.467519199250946, 1, 1, 0, 9.15028318574209, 0]], [[6.451782449799167, 1, 2, 0, 0.5171217861239685, 0], [5.467519199250946, 1, 1, 0, 4.6456119857420894, 0], [5.467519199250946, 1, 1, 0, 6.479988395742089, 0], [5.467519199250946, 1, 1, 0, 7.315906765742089, 0], [5.467519199250946, 1, 1, 0, 9.96298159574209, 0]], [[5.467519199250946, 1, 1, 0, 1.9753171957420899, 0], [6.451782449799167, 1, 2, 0, 3.1874165661239684, 0], [5.467519199250946, 1, 1, 0, 5.8066097157420895, 0], [5.467519199250946, 1, 1, 0, 8.47690449574209, 0], [5.467519199250946, 1, 1, 0, 9.63790223574209, 0]]], loop=false, balls=null){
    super();
    this.canvas = null;
    this.ctx = null;
    
    this.width = null;
    this.height = null
    
    this.balls = []
    
    // this.time = 0
    this.time_aux = 0
    
    this.t0 = 0//times[0]
    this.tn = 0//times[times.length - 1]
    
    this.throws = [[[5.467519199250946, 1, 1, 0, 0.6982196957420896, 0], [5.692749210796666, 1, 2, 0, 1.7347179045766312, 0], [5.467519199250946, 1, 1, 0, 4.111553025742089, 0], [5.467519199250946, 1, 1, 0, 5.110011075742089, 0], [5.467519199250946, 1, 1, 0, 6.45676844574209, 0], [5.467519199250946, 1, 1, 0, 8.337584775742089, 0]], [[5.467519199250946, 1, 1, 0, 0.3963602857420897, 0]], [[5.467519199250946, 1, 1, 0, 2.1610768357420893, 0], [5.467519199250946, 1, 1, 0, 3.06665506574209, 0], [5.467519199250946, 1, 1, 0, 5.992369355742089, 0], [5.467519199250946, 1, 1, 0, 7.45522649574209, 0], [5.467519199250946, 1, 1, 0, 8.778763905742089, 0]], [[5.467519199250946, 1, 1, 0, 1.2787185557420897, 0], [5.467519199250946, 1, 1, 0, 3.6471539357420895, 0], [5.467519199250946, 1, 1, 0, 4.52951220574209, 0], [5.467519199250946, 1, 1, 0, 5.41187048574209, 0], [5.467519199250946, 1, 1, 0, 6.89794758574209, 0], [5.467519199250946, 1, 1, 0, 7.757085905742089, 0], [5.467519199250946, 1, 1, 0, 9.21994304574209, 0]]]
    this.is_loop = false
    
    this.duration = 3
  }


  loop = () => {
    this.ctx.fillStyle = "rgba(0, 0, 0, 0.25)";
    this.ctx.fillRect(0, 0, this.width, this.height);

    const ball1 = new Ball(
      -1,this.ctx, this.width*0.4, this.height/2,
      "rgb(" + "100" + "," + "23" + "," + "1" + ")",
      30,
    ).draw();

    const ball2 = new Ball(
      -1,this.ctx, this.width*0.6, this.height/2,
      "rgb(" + "200" + "," + "200" + "," + "1" + ")",
      30,
    ).draw();
    
    //Claves 3 + 2 Fernan
    // var throws = [[[5.467519199250946, 1, 1, 0, 0.6982196957420896, 0], [5.692749210796666, 1, 2, 0, 1.7347179045766312, 0], [5.467519199250946, 1, 1, 0, 4.111553025742089, 0], [5.467519199250946, 1, 1, 0, 5.110011075742089, 0], [5.467519199250946, 1, 1, 0, 6.45676844574209, 0], [5.467519199250946, 1, 1, 0, 8.337584775742089, 0]], [[5.467519199250946, 1, 1, 0, 0.3963602857420897, 0]], [[5.467519199250946, 1, 1, 0, 2.1610768357420893, 0], [5.467519199250946, 1, 1, 0, 3.06665506574209, 0], [5.467519199250946, 1, 1, 0, 5.992369355742089, 0], [5.467519199250946, 1, 1, 0, 7.45522649574209, 0], [5.467519199250946, 1, 1, 0, 8.778763905742089, 0]], [[5.467519199250946, 1, 1, 0, 1.2787185557420897, 0], [5.467519199250946, 1, 1, 0, 3.6471539357420895, 0], [5.467519199250946, 1, 1, 0, 4.52951220574209, 0], [5.467519199250946, 1, 1, 0, 5.41187048574209, 0], [5.467519199250946, 1, 1, 0, 6.89794758574209, 0], [5.467519199250946, 1, 1, 0, 7.757085905742089, 0], [5.467519199250946, 1, 1, 0, 9.21994304574209, 0]]]
    
    //Reggeton reinaldo
    // var throws = [[[5.467519199250946, 1, 1, 0, 1.4837072200277996, 0], [5.467519199250946, 1, 1, 0, 2.5551357914563795, 0], [5.467519199250946, 1, 1, 0, 4.912278648599229, 0], [5.837291666666713, 1, 2, 0, 6.006817070432187, 0]], [[5.467519199250946, 1, 1, 0, 0.19799293431351866, 0]], [[5.467519199250946, 1, 1, 0, 0.8408500771706597, 0], [5.467519199250946, 1, 1, 0, 1.9122786485992298, 0], [5.837291666666657, 1, 2, 0, 3.221102784717904, 0], [5.467519199250946, 1, 1, 0, 5.34085007717066, 0], [5.467519199250946, 1, 1, 0, 6.197992934313519, 0]], [[5.467519199250946, 1, 1, 0, 1.0551357914563797, 0], [5.467519199250946, 1, 1, 0, 2.7694215057420895, 0], [5.467519199250946, 1, 1, 0, 3.6265643628849498, 0], [5.837291666666713, 1, 2, 0, 4.506817070432187, 0], [5.467519199250946, 1, 1, 0, 6.62656436288495, 0]]]
    
    //Final Reinaldo
    // var throws = [[[5.467519199250946, 1, 1, 0, 1.4837072200277996, 0]], [[5.467519199250946, 1, 1, 0, 1.0551357914563797, 0], [5.467519199250946, 1, 1, 0, 2.7694215057420895, 0]], [[5.467519199250946, 1, 1, 0, 0.19799293431351866, 0]], [[5.467519199250946, 1, 1, 0, 0.6265643628849467, 0]], [[5.467519199250946, 1, 1, 0, 0.8408500771706597, 0], [5.467519199250946, 1, 1, 0, 2.3408500771706597, 0]]]

    //Claves 2 + 3 Fernan
    // var throws = [[[6.325276882724722, 1, 2, 0, 0.024502436460453275, 0], [5.467519199250946, 1, 1, 0, 2.6486958857420895, 0], [5.467519199250946, 1, 1, 0, 3.8096936157420895, 0], [5.467519199250946, 1, 1, 0, 5.318990665742089, 0], [5.467519199250946, 1, 1, 0, 6.990827405742089, 0], [5.467519199250946, 1, 1, 0, 7.98928545574209, 0], [5.467519199250946, 1, 1, 0, 9.15028318574209, 0]], [[6.451782449799167, 1, 2, 0, 0.5171217861239685, 0], [5.467519199250946, 1, 1, 0, 4.6456119857420894, 0], [5.467519199250946, 1, 1, 0, 6.479988395742089, 0], [5.467519199250946, 1, 1, 0, 7.315906765742089, 0], [5.467519199250946, 1, 1, 0, 9.96298159574209, 0]], [[5.467519199250946, 1, 1, 0, 1.9753171957420899, 0], [6.451782449799167, 1, 2, 0, 3.1874165661239684, 0], [5.467519199250946, 1, 1, 0, 5.8066097157420895, 0], [5.467519199250946, 1, 1, 0, 8.47690449574209, 0], [5.467519199250946, 1, 1, 0, 9.63790223574209, 0]]]

    // Bossa FERNAN
    // var throws = [[[5.467519199250946, 1, 1, 0, 0.6285598257420897, 0], [5.467519199250946, 1, 1, 0, 1.7663376057420896, 0], [5.467519199250946, 1, 1, 0, 2.7647956557420894, 0], [5.467519199250946, 1, 1, 0, 3.74003374574209, 0], [5.467519199250946, 1, 1, 0, 4.877811525742089, 0], [5.467519199250946, 1, 1, 0, 5.829829665742089, 0], [5.467519199250946, 1, 1, 0, 6.990827405742089, 0], [5.467519199250946, 1, 1, 0, 7.9660654957420896, 0], [6.198771370131668, 1, 2, 0, 9.005276501356391, 0]], [[5.467519199250946, 1, 1, 0, 1.1393988257420897, 0], [5.467519199250946, 1, 1, 0, 2.2539566557420896, 0], [5.467519199250946, 1, 1, 0, 3.22919474574209, 0], [5.467519199250946, 1, 1, 0, 4.390192485742089, 0], [5.467519199250946, 1, 1, 0, 5.3654305757420895, 0], [5.467519199250946, 1, 1, 0, 6.34066867574209, 0], [5.467519199250946, 1, 1, 0, 7.478446445742089, 0], [6.198771370131668, 1, 2, 0, 8.49443750135639, 0]], [[5.467519199250946, 1, 1, 0, 0.14094077574208969, 0]]]

    //Danzon FERNAN
    // var throws = [[[5.467519199250946, 1, 1, 0, 1.3251584657420896, 0], [6.9578045546527765, 1, 2, 0, 2.6705515719061688, 0], [6.9578046091341665, 1, 2, 0, 5.247966533553731, 0], [5.467519199250946, 1, 1, 0, 7.5248863557420895, 0], [5.819254777871104, 1, 2, 0, 11.40151866050955, 0]], [[5.467519199250946, 1, 1, 0, 0.6749997357420897, 0], [5.467519199250946, 1, 1, 0, 2.1610768357420893, 0], [5.467519199250946, 1, 1, 0, 3.46139429574209, 0], [6.9578046091341665, 1, 2, 0, 4.8300073535537305, 0], [6.831299042059714, 1, 2, 0, 8.262628178662608, 0], [6.9578045546527765, 1, 2, 0, 10.820755651906168, 0]], [[6.9578046091341665, 1, 2, 0, 0.5343157435537306, 0], [5.467519199250946, 1, 1, 0, 3.0202151557420898, 0], [5.467519199250946, 1, 1, 0, 4.52951220574209, 0], [6.9578045546527765, 1, 2, 0, 5.665925721906168, 0], [5.467519199250946, 1, 1, 0, 7.9660654957420896, 0], [6.95780460913417, 1, 2, 0, 9.10247900355373, 0], [6.95780460913417, 1, 2, 0, 11.67989397355373, 0]], [[5.467519199250946, 1, 1, 0, 0.024841005742089695, 0], [5.467519199250946, 1, 1, 0, 1.0929589157420896, 0], [5.467519199250946, 1, 1, 0, 4.111553025742089, 0], [6.9578046091341665, 1, 2, 0, 7.38420236355373, 0], [5.819254723389721, 1, 2, 0, 9.915441567501022, 0], [5.467519199250946, 1, 1, 0, 13.30665506574209, 0]]]

    //Samba FERNAN
    // var throws = [[[5.467519199250946, 1, 1, 0, -0.06803881425791033, 0]], [[5.467519199250946, 1, 1, 0, 1.0000791057420897, 0], [5.467519199250946, 1, 1, 0, 2.0449770657420894, 0], [5.467519199250946, 1, 1, 0, 3.18275483574209, 0], [6.9578045546527765, 1, 2, 0, 4.3191683519061685, 0], [5.467519199250946, 1, 1, 0, 6.57286821574209, 0]], [[6.1987713701316665, 1, 2, 0, 0.2281336413563909, 0], [5.467519199250946, 1, 1, 0, 2.39327638574209, 0], [5.467519199250946, 1, 1, 0, 3.4381743357420893, 0], [5.467519199250946, 1, 1, 0, 4.483072295742089, 0], [5.467519199250946, 1, 1, 0, 5.29577071574209, 0], [5.467519199250946, 1, 1, 0, 6.108469125742089, 0], [5.467519199250946, 1, 1, 0, 6.89794758574209, 0]], [[5.467519199250946, 1, 1, 0, 0.5356800057420896, 0], [6.957804609134164, 1, 2, 0, 1.6488735635537304, 0], [5.467519199250946, 1, 1, 0, 3.90257343574209, 0], [5.692749210796667, 1, 2, 0, 4.730092054576631, 0], [5.467519199250946, 1, 1, 0, 7.153367085742089, 0]], [[5.467519199250946, 1, 1, 0, 0.7678795557420897, 0], [5.467519199250946, 1, 1, 0, 1.7895575557420897, 0], [5.692749210796667, 1, 2, 0, 2.6402961345766314, 0], [5.467519199250946, 1, 1, 0, 5.040351215742089, 0], [5.467519199250946, 1, 1, 0, 6.34066867574209, 0]]]

    // var is_loop = false
    

    while (this.balls.length < this.throws.length){
      const size = 15 //this.random(10, 20);

      const x = this.balls.length%2? this.width*0.6: this.width*0.4 //this.random(0 + size, this.width - size);
      const y = this.height/2 //this.random(0 + size, this.height - size);
      
      var red = this.random(0, 255);
      var green = this.random(0, 255);
      var blue = this.random(0, 255);

      const ball = new Ball(
        this.balls.length, this.ctx, x, y, 
        "rgb(" + red + "," + green + "," + blue + ")",
        size,
        this.balls.length%2, 
        this.load_throw(this.throws[this.balls.length])
      );

      this.is_loop && ball.calculate_initial_pos(this.t0, this.tn)

      this.balls.push(ball);
    }

    this.time_aux === 0 && (this.time_aux = new Date())

    this.is_loop? this.loop_problem(): this.default_problem()

    requestAnimationFrame(this.loop)
  }

  default_problem(){
    for (let i = 0; i < this.balls.length; i++){
      this.balls[i].draw()
      let current_time = ((new Date() - this.time_aux)/1000)
      if (this.balls[i].list_of_throw.length > this.balls[i].index_list && this.balls[i].list_of_throw[this.balls[i].index_list].initial_time <= current_time){
        this.balls[i].global_time = this.time_aux
        this.balls[i].apply_throw(this.width, this.height)
      }
    }
  }

  loop_problem(){
    for (let i = 0; i < this.balls.length; i++){
      this.balls[i].draw()
      var current_time = ((new Date() - this.time_aux)/1000) + this.t0

      if ((this.balls[i].list_of_throw.length > this.balls[i].index_list) && 
          this.balls[i].index_list >= 0 && 
          Math.abs(current_time - this.balls[i].list_of_throw[this.balls[i].index_list].initial_time) <= 0.1){
        this.balls[i].global_time = this.time_aux
        this.balls[i].is_move = true
        this.balls[i].apply_throw(this.width, this.height)
      }
      else{
        if (this.balls[i].is_move){
          this.balls[i].global_time = this.time_aux
          this.balls[i].apply_throw(this.width, this.height)
        }
      }
    }

    current_time > this.tn && (this.time_aux = new Date()) && this.reset_index() && console.log("RESET")
  }

  reset_index(){
    for (let i = 0; i < this.balls.length; i++){
      this.balls[i].index_list = this.balls[i].index_list%this.balls[i].list_of_throw.length
    }
    return true
  }

  reset_throws(){
    for (let i = 0; i < this.balls.length; i++){
      for (let j = 0; j < this.balls[i].list_of_throw.length; j++){
        this.balls[i].list_of_throw[j].is_done = false
      }
    }
    return true
  }

  random(min, max){
    return Math.floor(Math.random() * (max - min)) + min;
  }

  componentDidMount() {
    //set up the canvas
    this.canvas = this.refs.canvas;
    this.ctx = this.canvas.getContext("2d");
    this.width = this.canvas.width = window.innerWidth;
    this.height = this.canvas.height = window.innerHeight;
    // console.log(this.width*0.4, this.width*0.6)
    startRecording(this.canvas)
    //start the animation
    this.loop();
    

    // console.log("WH", this.width*0.4, this.width*0.6, this.height/2)
  }


  load_throw(throws_list){
    var result_list = []
    for(let i = 0; i < throws_list.length; i++){
      result_list.push(new Ball_Throw(
        throws_list[i][0], // v0
        throws_list[i][1], // change hand
        throws_list[i][2], // bounce amount
        throws_list[i][3], // catch ball
        throws_list[i][4], // initial time
        throws_list[i][5]  // total time
      ))
    }
    return result_list
  }

  render(pe) {
    return (
      <>
        <NavBar/>
        <div>
          <My_Audio></My_Audio>
          <canvas ref="canvas" id='canvas'/>
        </div>
      </>
    );
  }
}
